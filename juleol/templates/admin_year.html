{% from "_formhelper.html" import render_field %}
{% extends 'base.html' %}

{% block title %}Juleøl admin tasting year {{ tasting.year }}{% endblock %}
{%block content %}

<script>
  const year = {{ tasting.year }};

  function update_beer_name(obj, id) {
    var name = obj.value;
    $.ajax("/admin/beer/" + id, {
      method: "PUT",
      data: { "name": name },
      dataType: "json",
      success: function(data, textStatus, xhr) {
        $(obj).siblings("p").hide();
      },
      error: function(xhr, ajaxOptions, thrownError) {
        try {
          var msg = xhr.responseJSON.error;
        } catch {
          var msg = "Error updating beer";
        }
        $(obj).siblings("p").text(msg);
        $(obj).siblings("p").show();
      }
    });
  };

  function update_beer_heat(obj, id) {
    var heat = obj.value;
    var data;
    var method;
    var url;
    if(heat == 'None') {
      data = {};
      method = 'DELETE';
      url = "/admin/beer/" + id + "/heat";
    } else {
      data = {"heat": heat };
      method = "PUT";
      url = "/admin/beer/" + id;
    };
    $.ajax(url, {
      method: method,
      data: data,
      dataType: "json",
      success: function(data, textStatus, xhr) {
        $(obj).siblings("p").hide();
      },
      error: function(xhr, ajaxOptions, thrownError) {
        try {
          var msg = xhr.responseJSON.error;
        } catch {
          var msg = "Error updating beer";
        }
        $(obj).siblings("p").text(msg);
        $(obj).siblings("p").show();
      }
    });
  };

  function update_heat(obj, id) {
    var heat = obj.value;
    $.ajax("/admin/heat/" + id, {
      method: "PUT",
      data: { "name": heat },
      dataType: "json",
      success: function(data, textStatus, xhr) {
        $(obj).siblings("p").hide();
      },
      error: function(xhr, ajaxOptions, thrownError) {
        try {
          var msg = xhr.responseJSON.error;
        } catch {
          var msg = "Error updating heat";
        }
        $(obj).siblings("p").text(msg);
        $(obj).siblings("p").show();
      }
    });
  };

  function delete_heat(obj, id) {
    var name = obj.value;
    $.ajax("/admin/heat/" + id, {
      method: "DELETE",
      dataType: "json",
      success: function(data, textStatus, xhr) {
        $(obj).siblings("p").hide();
        $(obj).parent().remove()
      },
      error: function(xhr, ajaxOptions, thrownError) {
        try {
          var msg = xhr.responseJSON.error;
        } catch {
          var msg = "Error deleting heat";
        }
        $(obj).siblings("p").text(msg);
        $(obj).siblings("p").show();
      }
    });
  };

  function update_note(obj, id) {
    var note = obj.value;
    $.ajax("/admin/note/" + id, {
      method: "PUT",
      data: { "note": note },
      dataType: "json",
      success: function(data, textStatus, xhr) {
        $(obj).siblings("p").hide();
      },
      error: function(xhr, ajaxOptions, thrownError) {
        try {
          var msg = xhr.responseJSON.error;
        } catch {
          var msg = "Error updating note";
        }
        $(obj).siblings("p").text(msg);
        $(obj).siblings("p").show();
      }
    });
  };

  function delete_note(obj, id) {
    var name = obj.value;
    $.ajax("/admin/note/" + id, {
      method: "DELETE",
      dataType: "json",
      success: function(data, textStatus, xhr) {
        $(obj).siblings("p").hide();
        $(obj).parent().remove()
      },
      error: function(xhr, ajaxOptions, thrownError) {
        try {
          var msg = xhr.responseJSON.error;
        } catch {
          var msg = "Error deleting note";
        }
        $(obj).siblings("p").text(msg);
        $(obj).siblings("p").show();
      }
    });
  };
</script>

<h1>Juleøl admin tasting year {{ tasting.year }}</h1>

<h2>Beers</h2>
<dl>
  {% for beer in tasting.beers %}
  <dt>Beer {{ beer.number }}</dt>
  <dd><input type="text" value="{{ beer.name }}" onfocusout="update_beer_name(this, {{ beer.id }});"/>
  <select onchange="update_beer_heat(this, {{ beer.id }});">
    <option value="None" {% if not beer.heat %}selected="selected"{% endif %}>None</option>
    {% for heat in tasting.heats %}
    <option value="{{ heat.id }}"{% if beer.heat.id == heat.id %}selected="selected"{% endif %}>{{ heat.name }}</option>
    {% endfor %}
  </select>
  <p class="error" style="display: none;"/>
  </dd>
  {% endfor %}
</dl>

<h2>Heats</h2>
<ul>
  {% for heat in tasting.heats %}
  <li>
  <input type="text" value="{{ heat.name }}" onfocusout="update_heat(this, {{ heat.id }});"/>
  <input type="button" value="Delete" onclick="delete_heat(this, {{ heat.id }});"/>
  <p class="error" style="display: none;"/>
  </li>
  {% endfor %}
</ul>
<form action="/admin/{{ tasting.year }}/heat" method="post">
  <dl>
    {{ render_field(heat_form.name) }}
  </dl>
  <p><input type=submit value="Add heat"></p>
</form>

<h2>Notes</h2>
<ul>
  {% for note in tasting.notes %}
  <li>
  <input type="text" value="{{ note.note }}" onfocusout="update_note(this, {{ note.id }});"/>
  <input type="button" value="Delete" onclick="delete_note(this, {{ note.id }});"/>
  <p class="error" style="display: none;"/>
  </li>
  {% endfor %}
</ul>
<form action="/admin/{{ tasting.year }}/note" method="post">
  <dl>
    {{ render_field(note_form.note) }}
  </dl>
  <p><input type=submit value="Add note"></p>
</form>

<h2>Participants</h2>
<dl>
  {% for participant in tasting.participants %}
  <form action="/admin/{{ tasting.year }}/participant/{{ participant.id }}" method="post">
  <dt>{{ participant.name }}</dt>
  <dd><input type="password" name="password"/><input type="submit" value="Change password"/>
  </dd>
  </form>
  {% endfor %}
</dl>

<h2>New participant</h2>
<form action="/admin/{{ tasting.year }}/participant" method="post">
  <dl>
    {{ render_field(participant_form.name) }}
    {{ render_field(participant_form.password) }}
  </dl>
  <p><input type=submit value="Create"></p>
</form>

<p><a href="/admin/">Admin Home</a></p>
<p><a href="/">Home</a></p>

{% endblock %}
